# BigMind CDN - Cache Rules Configuration
# Phase 4 - Sprint 2 - CORE
# Detailed caching strategies for different content types

# Plugin packages (.tgz files)
# - Immutable content (versioned)
# - 1 year cache
# - stale-while-revalidate for availability
map $uri $plugin_cache_control {
    ~*/@bigmind/[^/]+/-/[^/]+\.tgz$ "public, max-age=31536000, immutable";
    default "no-cache";
}

# Plugin metadata (package.json, manifests)
# - Frequently updated
# - 5 minutes cache with revalidation
# - stale-while-revalidate for performance
map $uri $metadata_cache_control {
    ~*/@bigmind/[^/]+/?$ "public, max-age=300, stale-while-revalidate=60";
    default "no-cache";
}

# Static assets (images, icons, screenshots)
# - Long cache (24 hours)
# - Vary on Accept for image format negotiation (WebP)
map $uri $asset_cache_control {
    ~*/assets/.+\.(png|jpg|jpeg|gif|svg|webp|ico)$ "public, max-age=86400";
    ~*/assets/.+\.(woff|woff2|ttf|otf|eot)$ "public, max-age=604800";  # 7 days for fonts
    default "public, max-age=3600";
}

# Content types for proper MIME handling
map $uri $content_type_override {
    ~*\.tgz$ "application/gzip";
    ~*\.json$ "application/json";
    ~*\.js$ "application/javascript";
    ~*\.css$ "text/css";
    ~*\.svg$ "image/svg+xml";
    ~*\.woff2$ "font/woff2";
    ~*\.woff$ "font/woff";
    default "";
}

# SRI (Subresource Integrity) headers
# Add integrity hashes for critical resources
map $uri $integrity_header {
    # Example: /assets/plugin-abc-v1.2.3.js -> sha384-...
    # Generated dynamically by AssetVersioning system
    default "";
}

# Security headers by content type
map $uri $csp_header {
    ~*\.(js|css)$ "script-src 'self'; style-src 'self'";
    default "default-src 'self'";
}

# Prefetch hints for common patterns
map $uri $link_header {
    # Preload critical plugin dependencies
    ~*/@bigmind/core-plugin/-/.+\.tgz$ "</assets/react.js>; rel=preload; as=script";
    default "";
}
