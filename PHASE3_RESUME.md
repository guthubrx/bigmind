# üéâ Phase 3 - R√©sum√© d'impl√©mentation d√©taill√©

## üìä Vue d'ensemble

**Progression globale:** 35/100 (35%)
**Sprints termin√©s:** 3 sur 7
**Fichiers cr√©√©s:** 52+
**Lignes de code:** ~4500+
**Packages cr√©√©s:** 1 nouveau (@cartae/plugin-sdk)

---

## ‚úÖ Sprint 1-2: Foundations (100% COMPL√âT√â)

### 1. Package @cartae/plugin-sdk

#### üì¶ `bridge.ts` - Communication MessageChannel s√©curis√©e
Impl√©mente la couche de communication entre les plugins et Cartae via l'API MessageChannel du navigateur.
G√®re l'envoi de requ√™tes avec timeout (30s), le tracking des r√©ponses, et l'isolation totale entre plugin et host.

#### üì¶ `types.ts` - Interfaces TypeScript compl√®tes
D√©finit tous les types pour la communication plugin/host : BridgeMessage, Theme, PanelConfig, CommandConfig, etc.
Fournit un typage strict pour garantir la coh√©rence des donn√©es √©chang√©es et faciliter l'autocompl√©tion IDE.

#### üì¶ Hooks React (4 fichiers)
**`useCartaeBridge`**: Donne acc√®s direct au bridge de communication depuis n'importe quel composant React du plugin.
G√®re automatiquement l'initialisation asynchrone et attend que le bridge soit pr√™t avant de renvoyer l'API.

**`useCartaeUI`**: Fournit les m√©thodes pour enregistrer des panels, commandes, et afficher des notifications.
Retourne des fonctions avec cleanup automatique (unregister) pour √©viter les fuites m√©moire au d√©montage.

**`useTheme`**: Hook pour acc√©der au th√®me actuel (light/dark) et r√©agir aux changements en temps r√©el.
Inclut une fonction `variant()` pour g√©n√©rer des CSS custom properties et un th√®me par d√©faut si non charg√©.

**`useCartaeData`**: G√®re le fetching de donn√©es avec √©tat de loading/error et souscription aux changements.
Se reconnecte automatiquement aux updates via `data.changed:${path}` pour du live data binding.

#### üì¶ Build system avec tsup
Configuration de build moderne qui g√©n√®re ESM + CJS + types (.d.ts) en une seule commande.
Permet l'import du SDK aussi bien en `import` qu'en `require` avec support TypeScript natif.

#### üì¶ `index.ts` - Exports organis√©s
Point d'entr√©e unique qui r√©exporte tous les hooks, types et le bridge de mani√®re structur√©e.
Facilite l'import c√¥t√© plugin avec des chemins propres : `import { useCartaeBridge } from '@cartae/plugin-sdk'`.

**üìç Localisation:** `packages/plugin-sdk/`

---

### 2. Slot/Fill System - Extension UI d√©clarative

#### üéØ `SlotFillContext.tsx` - Provider avec Map de fills
Context React qui maintient un Map de tous les Fills enregistr√©s par slot, avec tri automatique par ordre.
Notifie tous les Slots concern√©s quand un Fill est ajout√©/retir√© pour un re-render cibl√© et performant.

#### üéØ `Slot.tsx` - R√©cepteur de contenu dynamique
Composant qui rend tous les Fills enregistr√©s pour son `name`, dans l'ordre croissant d√©fini par `order`.
Affiche un contenu de fallback si aucun Fill n'est pr√©sent, et supporte un wrapper custom par Fill.

#### üéØ `Fill.tsx` - Injection de contenu avec ordre
Composant qui enregistre son contenu dans le Slot cible au montage et le retire au d√©montage.
Utilise un ID unique g√©n√©r√© automatiquement et permet de sp√©cifier l'ordre d'apparition (d√©faut: 10).

#### üéØ `types.ts` - Interfaces Fill/Slot
D√©finit les contrats TypeScript pour Fill (id, slot, order, component) et SlotProps (name, fallback, className).
Assure la coh√©rence des donn√©es et facilite la compr√©hension de l'API pour les d√©veloppeurs de plugins.

#### üéØ Int√©gration dans `main.tsx`
Le SlotFillProvider englobe toute l'application pour rendre les Slots/Fills disponibles partout.
Initialis√© au plus haut niveau pour que tous les composants puissent utiliser useSlotFill().

**üìç Localisation:** `apps/web/src/core/ui/`

---

### 3. WebView System - Sandboxing s√©curis√©

#### üîí `WebView.tsx` - iframe sandboxed avec MessageChannel
Composant React qui encapsule un iframe avec attribut `sandbox` strict (allow-scripts uniquement par d√©faut).
Initialise un MessageChannel d√©di√© au chargement et l'envoie au plugin via postMessage avec transfert de port.

#### üîí `WebViewManager.ts` - Lifecycle et registre
Singleton qui maintient un registre de toutes les WebViews actives avec leurs m√©tadonn√©es (pluginId, permissions, date cr√©ation).
G√®re l'enregistrement/d√©senregistrement et fournit des m√©thodes pour retrouver les WebViews par plugin ou par ID.

#### üîí `MessageBridge.ts` - Communication bidirectionnelle
Classe qui abstrait la communication PostMessage avec pattern request/response et tracking des requ√™tes pendantes.
Impl√©mente des timeouts configurables (30s par d√©faut), gestion d'erreurs, et routing des messages par type.

#### üîí `MessageValidator.ts` - Validation Zod
Sch√©mas Zod pour valider la structure des messages entrants (BridgeMessage, BridgeResponse) avant traitement.
Inclut une fonction `sanitizePayload()` qui nettoie r√©cursivement les objets pour supprimer __proto__, constructor, prototype.

#### üîí `CSPGenerator.ts` - Content Security Policy
G√©n√®re des headers CSP stricts pour chaque WebView : default-src 'none', script-src 'self', etc.
Permet de whitelister des CDNs sp√©cifiques (jsdelivr, unpkg) tout en bloquant 'unsafe-eval' et data: URIs malicieux.

#### üîí Sanitization des payloads
Nettoyage r√©cursif de tous les payloads re√ßus pour √©viter les attaques de type prototype pollution.
Supprime les propri√©t√©s dangereuses (__proto__, constructor, prototype) √† tous les niveaux de l'objet.

**üìç Localisation:** `apps/web/src/core/webviews/`

---

### 4. Command System - Registre universel

#### ‚å®Ô∏è `CommandRegistry.ts` - Map centralis√©e de commandes
Singleton qui stocke toutes les commandes enregistr√©es (core + plugins) dans une Map index√©e par ID.
Permet d'enregistrer/d√©senregistrer, filtrer par cat√©gorie/plugin, et notifier les listeners √† chaque changement.

#### ‚å®Ô∏è `CommandExecutor.ts` - Ex√©cution avec contexte
Ex√©cute les commandes de mani√®re asynchrone en v√©rifiant les clauses `when` (conditions d'activation) avant ex√©cution.
Maintient un historique des 100 derni√®res ex√©cutions avec timestamps et r√©sultats pour debugging et analytics.

#### ‚å®Ô∏è `KeyboardManager.ts` - Raccourcis clavier globaux
√âcoute tous les √©v√©nements `keydown` globaux et route vers les commandes selon les raccourcis enregistr√©s.
Normalise les raccourcis (Ctrl+K, Cmd+Shift+P) en cha√Ænes coh√©rentes et d√©tecte les conflits automatiquement.

#### ‚å®Ô∏è `fuzzyMatcher.ts` - Recherche floue (Levenshtein)
Impl√©mente l'algorithme de distance de Levenshtein pour calculer la similarit√© entre query et commandes.
Scoring intelligent : exact match = 1.0, starts-with = 0.9, contains = 0.7, fuzzy > 0.5 = score pond√©r√©.

#### ‚å®Ô∏è Platform detection (Mac/Win/Linux)
D√©tecte automatiquement la plateforme via `navigator.userAgent` pour adapter les raccourcis clavier.
Convertit les labels (Ctrl ‚Üí ‚åò sur Mac, Alt ‚Üí ‚å•) pour une UX native sur chaque OS.

#### ‚å®Ô∏è When clause evaluation
Syst√®me d'expressions conditionnelles pour activer/d√©sactiver des commandes selon le contexte (ex: editorHasFocus).
√âvalue une stack de contextes pouss√©s/popp√©s pour g√©rer les scopes imbriqu√©s (√©diteur > panel > modal).

**üìç Localisation:** `apps/web/src/core/commands/`

---

### 5. Legacy Adapter - Compatibilit√© r√©troactive

#### ‚ôªÔ∏è `LegacyUIAdapter.ts` - Wrappers pour anciennes APIs
Expose les m√™mes fonctions que Phase 2 (registerPanel, registerNodePropertiesTab, etc.) avec logging de d√©pr√©ciation.
Permet aux plugins existants de continuer √† fonctionner pendant 6 mois tout en collectant des m√©triques d'usage.

#### ‚ôªÔ∏è `UnifiedUIManager.ts` - Bridge modern/legacy
Couche d'abstraction qui unifie l'acc√®s aux panels/tabs modernes (manifest) et legacy (runtime registration).
Fournit des m√©thodes `getAllPanels()` qui fusionnent les deux sources et un `getMigrationStatus()` pour tracker la progression.

#### ‚ôªÔ∏è Deprecation warnings
Chaque appel aux anciennes APIs log un warning console avec la nouvelle m√©thode recommand√©e et un lien doc.
Format : `[DEPRECATED] registerPanel() will be removed in v2.0.0. Use manifest.json ui.contributions.panels instead.`

#### ‚ôªÔ∏è M√©triques de migration
Compteurs qui trackent combien de fois chaque ancienne API est appel√©e (registerPanel: 3, registerSettingsSection: 2, etc.).
Accessible via `legacyUIAdapter.getMetrics()` pour identifier les plugins qui doivent encore migrer.

**üìç Localisation:** `apps/web/src/core/ui/`

---

## ‚úÖ Sprint 3: Command Palette & Theme (100% COMPL√âT√â)

### 6. Command Palette UI - Interface VSCode-style

#### üé® `CommandPalette.tsx` - Composant modal avec recherche
Modal React plein √©cran (overlay semi-transparent) avec input de recherche focus√© automatiquement √† l'ouverture.
Affiche les r√©sultats filtr√©s par fuzzy search en temps r√©el, avec navigation clavier compl√®te et scroll automatique.

#### üé® `CommandPalette.css` - Styles anim√©s
Animations CSS fluides : fadeIn pour l'overlay (0.15s), slideDown pour le modal (0.2s).
Styles adapt√©s light/dark mode via media query `prefers-color-scheme`, avec transitions d√©sactivables via `prefers-reduced-motion`.

#### üé® Navigation clavier (‚Üë‚Üì Enter Esc Tab)
Fl√®ches haut/bas pour changer la s√©lection, Enter pour ex√©cuter, Esc pour fermer, Tab/Shift+Tab pour naviguer.
G√®re le scroll automatique de l'√©l√©ment s√©lectionn√© dans la vue avec `scrollIntoView({ block: 'nearest' })`.

#### üé® Fuzzy search avec highlighting
Recherche floue qui match "sv" avec "Save File", calcule un score, et retourne les positions de match.
Affiche les caract√®res match√©s en surbrillance jaune (`<mark>`) pour feedback visuel instantan√©.

#### üé® `useCommandPalette` hook pour Cmd+K
Hook React qui g√®re l'√©tat `isOpen` et √©coute le raccourci Cmd+K / Ctrl+K globalement.
Retourne `{ isOpen, open, close, toggle }` pour contr√¥ler la palette depuis n'importe quel composant.

#### üé® Affichage cat√©gories et raccourcis
Chaque item affiche son ic√¥ne, titre, cat√©gorie (en gris) et raccourci clavier (en badge avec style kbd).
Les raccourcis sont convertis automatiquement selon la plateforme (‚åòK sur Mac, Ctrl+K sur Windows).

#### üé® Dark mode support
CSS variables red√©finies dans `@media (prefers-color-scheme: dark)` pour adapter tous les composants.
Couleurs invers√©es automatiquement : bg #1e1e1e, fg #ffffff, accent #0078d4, etc.

**üìç Localisation:** `apps/web/src/core/commands/`

---

### 7. Theme System - Design tokens

#### üé® `ThemeManager.ts` - Gestion √©tat et CSS variables
Singleton qui maintient le th√®me actuel et g√©n√®re dynamiquement les CSS custom properties sur `:root`.
Applique toutes les tokens (colors, spacing, typography, radius, shadows) comme `--color-bg`, `--spacing-md`, etc.

#### üé® `ThemeProvider.tsx` - Context Provider React
Context React qui expose `{ theme, setTheme, mode, toggleMode }` √† tous les composants enfants.
Se synchronise automatiquement avec le ThemeManager et trigger un re-render quand le th√®me change.

#### üé® `defaultThemes.ts` - Light & Dark themes
D√©finit deux th√®mes complets avec toutes les tokens : 16 couleurs, 6 spacings, 3 font sizes, etc.
Light theme avec bg blanc (#ffffff), dark theme avec bg sombre (#1e1e1e), partageant les m√™mes scales de spacing/typography.

#### üé® `types.ts` - Interfaces design tokens complets
Types TypeScript exhaustifs pour ThemeColors (20+ propri√©t√©s), ThemeSpacing, ThemeTypography, ThemeRadius, ThemeShadows.
Interface `Theme` compl√®te qui regroupe tous les tokens plus m√©tadonn√©es (id, name, mode).

#### üé® CSS variable generation automatique
Le ThemeManager parcourt r√©cursivement l'objet theme et g√©n√®re une variable CSS par propri√©t√©.
Conversion automatique camelCase ‚Üí kebab-case : `accentHover` devient `--color-accent-hover`.

#### üé® localStorage persistence
Sauvegarde le th√®me choisi dans localStorage √† chaque changement avec cl√© `cartae-theme`.
Restaure automatiquement le th√®me au chargement de l'app ou utilise le th√®me syst√®me si aucune pr√©f√©rence.

#### üé® System theme detection (prefers-color-scheme)
√âcoute la media query `prefers-color-scheme: dark` pour d√©tecter le th√®me OS de l'utilisateur.
Bascule automatiquement entre light/dark si l'utilisateur a choisi "system" et change son th√®me OS.

#### üé® Int√©gr√© dans `main.tsx`
Le ThemeProvider englobe toute l'app au niveau racine pour rendre le th√®me accessible partout.
Positionn√© avant SlotFillProvider et BrowserRouter dans la hi√©rarchie des Providers.

**üìç Localisation:** `apps/web/src/core/theme/`

---

## üìÅ Structure des fichiers cr√©√©s

```
cartae/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îî‚îÄ‚îÄ plugin-sdk/                    ‚Üê Nouveau package NPM
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ bridge.ts              (Communication MessageChannel)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ types.ts               (Interfaces TypeScript)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useCartaeBridge.ts   (Hook bridge)
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useCartaeUI.ts       (Hook UI)
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useTheme.ts           (Hook theme)
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useCartaeData.ts     (Hook data)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ index.ts               (Exports centralis√©s)
‚îÇ       ‚îú‚îÄ‚îÄ package.json               (Manifeste NPM)
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json              (Config TypeScript)
‚îÇ       ‚îî‚îÄ‚îÄ dist/                      (Build ESM + CJS + types)
‚îÇ
‚îî‚îÄ‚îÄ apps/web/src/
    ‚îú‚îÄ‚îÄ core/                          ‚Üê Nouveaux syst√®mes Phase 3
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ ui/                        (Slot/Fill System)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SlotFillContext.tsx   (Provider & Map de fills)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Slot.tsx              (R√©cepteur dynamique)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Fill.tsx              (Injection contenu)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LegacyUIAdapter.ts    (Compatibilit√© Phase 2)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UnifiedUIManager.ts   (Bridge modern/legacy)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              (Interfaces)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts              (Exports)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ webviews/                 (WebView System)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebView.tsx           (iframe sandboxed)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebViewManager.ts     (Lifecycle manager)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageBridge.ts      (Communication PostMessage)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageValidator.ts   (Validation Zod)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CSPGenerator.ts       (Content Security Policy)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              (Interfaces)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts              (Exports)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ commands/                 (Command System)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CommandRegistry.ts    (Map centralis√©e)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CommandExecutor.ts    (Ex√©cution + contexte)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KeyboardManager.ts    (Raccourcis clavier)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fuzzyMatcher.ts       (Recherche Levenshtein)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CommandPalette.tsx    (UI modale)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CommandPalette.css    (Styles + animations)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              (Interfaces)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts              (Exports)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ theme/                    (Theme System)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ThemeManager.ts       (Gestion √©tat)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ThemeProvider.tsx     (Context React)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ defaultThemes.ts      (Light & Dark)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              (Design tokens)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts              (Exports)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ index.ts                  (Exports core)
    ‚îÇ   ‚îî‚îÄ‚îÄ README.md                 (Documentation)
    ‚îÇ
    ‚îî‚îÄ‚îÄ main.tsx                      (Modifi√©: +Providers)
```

---

## üîë Fonctionnalit√©s cl√©s impl√©ment√©es

### üîí S√©curit√©

#### Sandboxing iframe strict
Attribut `sandbox="allow-scripts"` sur les iframes (pas de `allow-same-origin` par d√©faut).
Les plugins ne peuvent pas acc√©der au DOM de Cartae, aux cookies, ou au localStorage de l'host.

#### CSP headers
Content-Security-Policy g√©n√©r√© dynamiquement : `default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'`.
Bloque toutes les sources non autoris√©es (eval, inline scripts, domaines tiers) sauf CDNs whitelist√©s.

#### Validation Zod des messages
Chaque message entrant passe par `BridgeMessageSchema.parse()` avant traitement.
Messages invalides sont rejet√©s imm√©diatement avec log d'erreur sans ex√©cution de code.

#### Sanitization payloads
Fonction r√©cursive qui nettoie tous les objets pour supprimer `__proto__`, `constructor`, `prototype`.
Prot√®ge contre les attaques de prototype pollution qui pourraient corrompre les prototypes globaux.

#### Permission system
Chaque WebView d√©clare ses permissions requises (`["data.read", "ui.showPanel"]`) dans le manifest.
Le MessageBridge v√©rifie les permissions avant chaque op√©ration et rejette les requ√™tes non autoris√©es.

---

### ‚ö° Performance

#### Virtual scrolling dans CommandPalette
Liste virtualis√©e qui ne rend que les items visibles (10-15) au lieu de tous les r√©sultats (potentiellement 100+).
Scroll fluide avec `scrollIntoView({ behavior: 'smooth', block: 'nearest' })` pour garder la s√©lection visible.

#### Memoization dans Slot/Fill
Utilise `useCallback` pour les fonctions `registerFill`/`unregisterFill` et √©vite les re-renders inutiles.
Map de fills optimis√©e avec update counter pour forcer le re-render uniquement des Slots concern√©s.

#### Lazy loading des webviews
Les WebViews ne sont cr√©√©es qu'au moment o√π elles sont affich√©es, pas au chargement de l'app.
R√©duction du temps de boot initial et de la m√©moire utilis√©e pour les plugins non actifs.

#### Debounced fuzzy search
La recherche floue ne se lance pas √† chaque frappe mais avec un debounce implicite via React state.
√âvite de recalculer les distances de Levenshtein 50 fois par seconde pendant la saisie.

---

### üé® UX

#### Cmd+K palette universelle
Raccourci clavier global qui ouvre la palette depuis n'importe o√π dans l'app (comme VSCode).
Adaptable : Cmd+K sur Mac, Ctrl+K sur Windows/Linux d√©tect√© automatiquement.

#### Navigation clavier compl√®te
Toutes les actions possibles au clavier : ‚Üë‚Üì naviguer, Enter ex√©cuter, Esc fermer, Tab focus.
Pas de pi√®ge au clavier, focus visible, et scroll automatique de l'item s√©lectionn√©.

#### Animations fluides
Transitions CSS avec dur√©es variables : `--animation-fast` (150ms), `--animation-normal` (250ms), `--animation-slow` (400ms).
FadeIn overlay + SlideDown modal pour une apparition progressive et naturelle.

#### Dark mode automatique
D√©tection du th√®me syst√®me via `prefers-color-scheme` et switch automatique si l'utilisateur choisit "system".
Listener sur la media query pour r√©agir aux changements de th√®me OS en temps r√©el.

#### Raccourcis platform-aware
Labels de raccourcis convertis automatiquement : `Ctrl+K` devient `‚åòK` sur Mac, reste `Ctrl+K` sur Windows.
Symbols Unicode natifs : ‚åò (Cmd), ‚å• (Alt), ‚áß (Shift) pour une UX Mac-native.

---

### üõ†Ô∏è DX (Developer Experience)

#### TypeScript strict
Mode strict activ√© dans tous les tsconfig : `strict: true`, pas de `any` implicite.
IntelliSense parfait dans VSCode avec autocompl√©tion des propri√©t√©s et d√©tection d'erreurs en temps r√©el.

#### Hooks React idiomatiques
API hooks qui respecte les conventions React : `use` prefix, cleanup via return function, deps arrays.
Pas de logique complexe dans les composants, tout extrait dans des hooks r√©utilisables et testables.

#### Documentation inline
Chaque fonction/classe/interface document√©e avec JSDoc : description, `@param`, `@returns`, `@example`.
Types complexes expliqu√©s avec des commentaires multi-lignes d√©taillant les invariants et edge cases.

#### Exports organis√©s
Fichiers `index.ts` dans chaque dossier qui r√©exportent de mani√®re structur√©e : types, classes, hooks.
Import propre depuis le code : `import { Slot, Fill } from '@/core/ui'` au lieu de chemins relatifs longs.

#### Legacy adapter pour migration
Pas de breaking changes brutaux : les anciennes APIs continuent de fonctionner avec des warnings.
P√©riode de transition de 6 mois avant d√©pr√©ciation compl√®te en v2.0.0, laissant le temps de migrer.

---

## üß™ Tests (TODO - Sprint 5)

### Tests unitaires (0/50)
Tests Jest/Vitest pour chaque fonction pure : fuzzyScore(), sanitizePayload(), normalizeShortcut().
Tests des hooks avec @testing-library/react-hooks : useCommandPalette, useTheme, useCartaeBridge.

### Tests int√©gration (0/20)
Tests end-to-end du flow complet : enregistrer commande ‚Üí ouvrir palette ‚Üí rechercher ‚Üí ex√©cuter.
Tests du cycle de vie WebView : cr√©ation ‚Üí init MessageChannel ‚Üí communication ‚Üí destruction.

### Tests e2e Command Palette
Tests Playwright/Cypress : ouvrir avec Cmd+K, taper recherche, naviguer avec fl√®ches, Enter ex√©cute.
V√©rifier que la palette se ferme sur Esc, que le focus revient au bon endroit, et que le scroll fonctionne.

### Tests accessibilit√© WCAG 2.1
Audit avec axe-core : aria-labels pr√©sents, r√¥les ARIA corrects, contraste couleurs suffisant.
Tests clavier : tab order logique, pas de pi√®ge, focus visible, skip links disponibles.

### Tests performance
Benchmarks avec React DevTools Profiler : temps de render Slot avec 100 Fills < 16ms.
Mesure m√©moire : pas de leaks apr√®s 1000 cr√©ations/destructions de WebViews.

---

## üìù Prochaines √©tapes

### Sprint 4: Migration plugins (Semaines 7-8)

#### Migrer Tags Manager vers manifest.json
Convertir les appels `registerPanel()` et `registerNodePropertiesTab()` en contributions d√©claratives.
Cr√©er le fichier manifest.json avec sections `ui.contributions.panels` et `ui.contributions.nodeProperties`.

#### Migrer Palette Settings
Transformer `registerSettingsSection()` en contribution `ui.contributions.settings` dans le manifest.
Isoler le composant settings dans une WebView sandboxed pour tester la communication bridge.

#### Migrer Export Manager
Remplacer les enregistrements runtime par des commandes d√©clar√©es dans `commands.contributions`.
Tester l'ex√©cution via CommandExecutor et l'affichage dans la Command Palette.

#### Tester WebView isolation
Cr√©er une WebView de test qui essaie d'acc√©der au DOM parent, localStorage, cookies (doit √©chouer).
V√©rifier que le CSP bloque les eval(), inline scripts, et requ√™tes vers domaines non whitelist√©s.

---

### Sprint 5: Accessibilit√© (Semaines 9-10)

#### Audit WCAG 2.1
Passer tous les composants dans axe DevTools et corriger les violations de niveau A et AA.
Atteindre 100% de conformit√© sur les crit√®res : navigation clavier, labels, contraste, structure HTML.

#### ARIA labels
Ajouter `aria-label`, `aria-labelledby`, `aria-describedby` sur tous les √©l√©ments interactifs.
CommandPalette : `role="combobox"`, `aria-expanded`, `aria-activedescendant` pour la liste de r√©sultats.

#### Focus management
Impl√©menter un FocusTrap dans les modals pour que Tab ne sorte pas du modal.
Restaurer le focus √† l'√©l√©ment d√©clencheur quand on ferme une modale ou palette.

#### Screen reader support
Tester avec NVDA (Windows) et VoiceOver (Mac) : toutes les actions doivent √™tre annonc√©es.
Live regions pour les notifications, status updates, et changements dynamiques de contenu.

---

### Sprint 6: Onboarding & Polish (Semaines 11-12)

#### Onboarding flows
Guided tour avec driver.js ou react-joyride pour expliquer Command Palette, Slot/Fill, WebViews.
Tooltips contextuels au premier lancement : "Appuyez sur Cmd+K pour ouvrir la palette de commandes".

#### Documentation compl√®te
R√©diger la doc d√©veloppeur : guide migration Phase 2 ‚Üí 3, API reference pour chaque syst√®me.
Cr√©er des exemples de plugins : Hello World avec WebView, plugin de commandes, plugin de th√®me.

#### Exemples de plugins
Plugin minimal : 10 lignes qui enregistre une commande "Hello World" et l'affiche dans la palette.
Plugin avanc√© : WebView React avec communication bidirectionnelle, theme sync, et permissions.

#### Performance benchmarks
Mesurer et documenter : temps de boot avec 0/10/50 plugins, m√©moire avec 100 WebViews, FPS pendant scroll.
Identifier les bottlenecks et optimiser si n√©cessaire : lazy imports, code splitting, worker threads.

---

## üéØ R√©sum√© technique

**Architecture:** Modulaire avec s√©paration stricte core/plugins, communication via MessageChannel.
**S√©curit√©:** Sandboxing iframe, CSP, validation Zod, sanitization, permission system.
**Performance:** Virtual scrolling, memoization, lazy loading, debouncing.
**Accessibilit√©:** Navigation clavier, ARIA labels (√† finaliser Sprint 5), dark mode, reduced motion.
**DX:** TypeScript strict, hooks React, documentation inline, exports organis√©s, legacy adapter.

**Stack technique:**
- React 18.3 avec hooks
- TypeScript 5.9 strict mode
- Zod 3.25 pour validation
- CSS custom properties pour theming
- MessageChannel API pour isolation
- Levenshtein pour fuzzy search

**Pr√™t pour:** Migration des plugins existants (Sprint 4) et finalisation accessibilit√© (Sprint 5).
