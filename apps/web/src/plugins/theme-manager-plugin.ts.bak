/**
 * Theme Manager Plugin
 * Provides interface themes (Light/Dark)
 */

import type { IPluginContext, PluginManifest } from '@bigmind/plugin-system';
import { getAllInterfaceThemes, getTheme, applyThemeToDocument } from '../themes/colorThemes';

export const manifest: PluginManifest = {
  id: 'com.bigmind.theme-manager',
  name: 'Theme Manager',
  version: '1.0.0',
  description: 'Gère les thèmes d\'interface Light et Dark pour personnaliser l\'apparence de BigMind',
  author: {
    name: 'BigMind Team',
    email: 'team@bigmind.com',
  },
  main: 'theme-manager-plugin.js',
  icon: '🌓',
  category: 'theme',
  tags: ['theme', 'dark-mode', 'light-mode', 'appearance', 'ui'],
  license: 'MIT',
  bigmindVersion: '^1.0.0',

  // Features
  features: [
    {
      label: 'Mode Light',
      description: 'Interface claire et lumineuse pour un environnement bien éclairé',
      icon: '☀️',
    },
    {
      label: 'Mode Dark',
      description: 'Interface sombre pour réduire la fatigue oculaire en faible luminosité',
      icon: '🌙',
    },
    {
      label: 'Variables CSS globales',
      description: 'Tous les composants s\'adaptent automatiquement au thème sélectionné',
      icon: '🎨',
    },
  ],

  // Changelog
  changelog: [
    {
      version: '1.0.0',
      date: '2025-01-28',
      changes: [
        {
          type: 'added',
          description: 'Thème Light avec palette claire',
        },
        {
          type: 'added',
          description: 'Thème Dark avec palette sombre',
        },
        {
          type: 'added',
          description: 'Application automatique des variables CSS',
        },
        {
          type: 'added',
          description: 'Persistance du thème sélectionné',
        },
      ],
    },
  ],

  // Hooks
  hooks: {
    listens: ['theme.changed'], // Écoute les changements de thème
    emits: [], // N'émet pas d'événements
  },

  // UI Contributions
  uiContributions: {
    commands: ['themes.list', 'themes.get', 'themes.apply'],
    menus: ['Settings > Appearance > Theme'],
    panels: [],
    settings: true,
  },

  permissions: [],
};

export async function activate(context: IPluginContext): Promise<void> {
  console.log('🌓 [Theme Manager] Plugin activé');

  // Register command to list all themes
  context.commands.registerCommand('themes.list', async () => {
    return getAllInterfaceThemes();
  });

  // Register command to get a specific theme
  context.commands.registerCommand('themes.get', async (themeId: string) => {
    const theme = getTheme(themeId);
    if (!theme) {
      throw new Error(`Theme "${themeId}" not found`);
    }
    return theme;
  });

  // Register command to apply a theme
  context.commands.registerCommand('themes.apply', async (themeId: string) => {
    const theme = getTheme(themeId);
    if (!theme) {
      throw new Error(`Theme "${themeId}" not found`);
    }

    applyThemeToDocument(theme);
    console.log(`🌓 [Theme Manager] Theme "${theme.name}" applied`);

    return theme;
  });

  // Listen to theme changes
  context.hooks.registerAction('theme.changed', async (data: any) => {
    console.log(`🌓 [Theme Manager] Theme changed:`, data);
  });

  const themeCount = getAllInterfaceThemes().length;
  console.log(`🌓 [Theme Manager] ${themeCount} thèmes disponibles`);
}

export async function deactivate(): Promise<void> {
  console.log('🌓 [Theme Manager] Plugin désactivé');
}
